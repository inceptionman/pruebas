{% extends "base.html" %}

{% block title %}Factura {{ invoice.folio }} - GameTech Store{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-file-invoice me-2"></i>Factura Electrónica</h2>
                <div>
                    <a href="{{ url_for('invoice.descargar_factura', invoice_id=invoice.id) }}" 
                       class="btn btn-primary">
                        <i class="fas fa-download me-2"></i>Descargar PDF
                    </a>
                    <a href="{{ url_for('invoice.mis_facturas') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-list me-2"></i>Mis Facturas
                    </a>
                </div>
            </div>

            <!-- Factura -->
            <div class="card shadow-lg">
                <div class="card-body p-4">
                    <!-- Estado -->
                    <div class="text-end mb-3">
                        {% if invoice.status == 'active' %}
                            <span class="badge bg-success fs-6">ACTIVA</span>
                        {% else %}
                            <span class="badge bg-danger fs-6">CANCELADA</span>
                        {% endif %}
                    </div>

                    <!-- Encabezado -->
                    <div class="text-center mb-4">
                        <h3 class="text-primary">FACTURA ELECTRÓNICA</h3>
                        <p class="text-muted mb-0">Comprobante Fiscal Digital por Internet</p>
                    </div>

                    <!-- Emisor y Receptor -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-header bg-primary text-white">
                                    <strong>EMISOR</strong>
                                </div>
                                <div class="card-body">
                                    <p class="mb-1"><strong>{{ invoice.razon_social_emisor }}</strong></p>
                                    <p class="mb-1"><small>RFC: {{ invoice.rfc_emisor }}</small></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-header bg-info text-white">
                                    <strong>RECEPTOR</strong>
                                </div>
                                <div class="card-body">
                                    <p class="mb-1"><strong>{{ invoice.razon_social_receptor }}</strong></p>
                                    <p class="mb-1"><small>RFC: {{ invoice.rfc_receptor }}</small></p>
                                    <p class="mb-1"><small>Dirección: {{ invoice.direccion_fiscal or 'N/A' }}</small></p>
                                    <p class="mb-0"><small>CP: {{ invoice.codigo_postal or 'N/A' }}</small></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Datos de la Factura -->
                    <div class="table-responsive mb-4">
                        <table class="table table-bordered">
                            <tr>
                                <th>Campo</th>
                                <th>Valor</th>
                            </tr>
                            <tr>
                                <td class="bg-light"><strong>Folio:</strong></td>
                                <td>{{ invoice.folio }}</td>
                            </tr>
                            <tr>
                                <td class="bg-light"><strong>UUID:</strong></td>
                                <td><small>{{ invoice.uuid }}</small></td>
                            </tr>
                            <tr>
                                <td class="bg-light"><strong>Fecha Emisión:</strong></td>
                                <td>{{ invoice.fecha_emision.strftime('%d/%m/%Y %H:%M:%S') }}</td>
                            </tr>
                            <tr>
                                <td class="bg-light"><strong>Fecha Timbrado:</strong></td>
                                <td>{{ invoice.fecha_timbrado.strftime('%d/%m/%Y %H:%M:%S') }}</td>
                            </tr>
                            <tr>
                                <td class="bg-light"><strong>Método de Pago:</strong></td>
                                <td>PUE - Pago en una exhibición</td>
                            </tr>
                            <tr>
                                <td class="bg-light"><strong>Forma de Pago:</strong></td>
                                <td>{{ invoice.forma_pago }}</td>
                            </tr>
                            <tr>
                                <td class="bg-light"><strong>Uso de CFDI:</strong></td>
                                <td>{{ invoice.uso_cfdi }}</td>
                            </tr>
                            <tr>
                                <td class="bg-light"><strong>Moneda:</strong></td>
                                <td>MXN - Peso Mexicano</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Conceptos -->
                    <h5 class="mb-3">Conceptos</h5>
                    <div class="table-responsive mb-4">
                        <table class="table table-striped">
                            <thead class="table-success">
                                <tr>
                                    <th>Cantidad</th>
                                    <th>Descripción</th>
                                    <th class="text-end">Precio Unitario</th>
                                    <th class="text-end">Importe</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in invoice.order.items %}
                                <tr>
                                    <td>{{ item.quantity }}</td>
                                    <td>{{ item.product_name }}</td>
                                    <td class="text-end">${{ "%.2f"|format(item.price) }}</td>
                                    <td class="text-end">${{ "%.2f"|format(item.get_subtotal()) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Totales -->
                    <div class="row">
                        <div class="col-md-6 offset-md-6">
                            <table class="table">
                                <tr>
                                    <th class="text-end">Concepto</th>
                                    <th class="text-end">Monto</th>
                                </tr>
                                <tr>
                                    <td class="text-end"><strong>Subtotal:</strong></td>
                                    <td class="text-end">${{ "%.2f"|format(invoice.subtotal) }}</td>
                                </tr>
                                <tr>
                                    <td class="text-end"><strong>IVA (16%):</strong></td>
                                    <td class="text-end">${{ "%.2f"|format(invoice.iva) }}</td>
                                </tr>
                                <tr class="table-primary">
                                    <td class="text-end"><strong>TOTAL:</strong></td>
                                    <td class="text-end"><strong class="fs-5">${{ "%.2f"|format(invoice.total) }}</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <hr>

                    <!-- Sello Digital -->
                    {% if invoice.sello_digital %}
                    <div class="mb-3">
                        <h6>Sello Digital del CFDI:</h6>
                        <p class="small text-muted font-monospace">{{ invoice.sello_digital[:100] }}...</p>
                    </div>
                    {% endif %}

                    <!-- Cadena Original -->
                    {% if invoice.cadena_original %}
                    <div class="mb-3">
                        <h6>Cadena Original del Complemento de Certificación Digital del SAT:</h6>
                        <p class="small text-muted font-monospace">{{ invoice.cadena_original }}</p>
                    </div>
                    {% endif %}

                    <!-- Nota Legal -->
                    <div class="text-center mt-4 text-muted small">
                        <p class="mb-1">Este documento es una representación impresa de un CFDI</p>
                        <p class="mb-0">Para verificar su validez consulte: www.sat.gob.mx</p>
                    </div>
                </div>
            </div>

            <!-- Acciones adicionales -->
            {% if current_user.is_admin and invoice.status == 'active' %}
            <div class="card shadow mt-3">
                <div class="card-body">
                    <h6 class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Acciones Administrativas</h6>
                    <form method="POST" action="{{ url_for('invoice.cancelar_factura', invoice_id=invoice.id) }}" 
                          onsubmit="return confirm('¿Estás seguro de cancelar esta factura?');">
                        <button type="submit" class="btn btn-danger btn-sm">
                            <i class="fas fa-ban me-2"></i>Cancelar Factura
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
